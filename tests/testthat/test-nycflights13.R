# sqlite ----

context("nycflights13 writing functions")

test_that("nycflights sqlite can be created", {
  # with DBI
  con <- nycflights13_sqlite()
  expect_is(con, "SQLiteConnection")
  expect_identical(
    dbListTables(con),
    c("airlines", "airports", "flights", "planes", "weather")
  )
  dbDisconnect(con)

  # with dplyr
  con <- nycflights13_sqlite(method = "dplyr")
  expect_is(con, "SQLiteConnection")
  expect_identical(
    dbListTables(con),
    c("airlines", "airports", "flights", "planes", "sqlite_stat1", "sqlite_stat4", "weather")
  )
  dbDisconnect(con)
})


skip_locally("use postgres-docker.sh and then this can be unskipped locally")

# psql ----

con <- list(
  odbc = DBI::dbConnect(
    odbc::odbc(),
    Driver   = "PostgreSQL Unicode",
    Server   = "127.0.0.1",
    Database = "postgres",
    UID      = "travis",
    PWD      = "",
    Port     = 5432
  ),
  rpostgresql = RPostgreSQL::dbConnect(
    drv = DBI::dbDriver("PostgreSQL"),
    host = "127.0.0.1",
    dbname = "postgres",
    user = "travis",
    password = "",
    port = 5432
  ),
  rpostgres = DBI::dbConnect(
    drv = RPostgres::Postgres(),
    host = "127.0.0.1",
    dbname = "postgres",
    user = "travis",
    password = "",
    port = 5432
  )
)

# odbc ----

test_that("DBI, with a new schema creation and odbc package", {
  expect_message(
    nycflights13_sql(con$odbc, schema = "odbc"),
    paste0(c(
      "using DBI to create the database",
      "Creating table: airlines",
      "Creating table: airports",
      "Creating table: flights",
      "Creating table: planes",
      "Creating table: weather"
    ),
    collapse = "|"
    )
  )
})

test_that("DBI, with a same schema creation and odbc package", {
  expect_message(
    nycflights13_sql(con$odbc, schema = "odbc"),
    "using DBI to create the database"
  )
})

test_that("dplyr, with a new schema creation and odbc package", {
  expect_message(
    nycflights13_sql(con$odbc, method = "dplyr", schema = "odbc_other"),
    paste0(c(
      "using dplyr to create the database",
      "Creating table: airlines",
      "Creating table: airports",
      "Creating table: flights",
      "Creating table: planes",
      "Creating table: weather"
    ),
    collapse = "|"
    )
  )
})

dbDisconnect(con$odbc)

# rpostgresql ----

test_that("DBI, with a new schema creation and rpostgresql package", {
  expect_message(
    nycflights13_sql(con$rpostgresql, schema = "rpostgresql"),
    paste0(c(
      "using DBI to create the database",
      "Creating table: airlines",
      "Creating table: airports",
      "Creating table: flights",
      "Creating table: planes",
      "Creating table: weather"
    ),
    collapse = "|"
    )
  )
})

test_that("DBI, with a same schema creation and rpostgresql package", {
  expect_message(
    nycflights13_sql(con$rpostgresql, schema = "rpostgresql"),
    "using DBI to create the database"
  )
})

test_that("dplyr, with a new schema creation and rpostgresql package", {
  expect_message(
    nycflights13_sql(con$rpostgresql, method = "dplyr", schema = "rpostgresql_other"),
    paste0(c(
      "using dplyr to create the database",
      "Creating table: airlines",
      "Creating table: airports",
      "Creating table: flights",
      "Creating table: planes",
      "Creating table: weather"
    ),
    collapse = "|"
    )
  )
})

dbDisconnect(con$rpostgresql)

# rpostgres ----

test_that("DBI, with a new schema creation and rpostgres package", {
  expect_message(
    nycflights13_sql(con$rpostgres, schema = "rpostgres"),
    paste0(c(
      "using DBI to create the database",
      "Creating table: airlines",
      "Creating table: airports",
      "Creating table: flights",
      "Creating table: planes",
      "Creating table: weather"
    ),
    collapse = "|"
    )
  )
})

test_that("DBI, with a same schema creation and rpostgres package", {
  expect_message(
    nycflights13_sql(con$rpostgres, schema = "rpostgres"),
    "using DBI to create the database"
  )
})

test_that("dplyr, with a new schema creation and rpostgres package", {
  expect_message(
    nycflights13_sql(con$rpostgres, method = "dplyr", schema = "rpostgres_other"),
    paste0(c(
      "using dplyr to create the database",
      "Creating table: airlines",
      "Creating table: airports",
      "Creating table: flights",
      "Creating table: planes",
      "Creating table: weather"
    ),
    collapse = "|"
    )
  )
})

dbDisconnect(con$rpostgres)
