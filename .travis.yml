# R for travis: see documentation at https://docs.travis-ci.com/user/languages/r

language: R
cache: packages

# linux builds should be able to use the docker set up, but have been
# segfaulting on connection with either MariaDB or RPostgres
before_install:
  - if [ $TRAVIS_OS_NAME = "linux" ]; then sudo /etc/init.d/postgresql stop || true; bash db-setup/postgres-docker.sh; fi
  - if [ $TRAVIS_OS_NAME = "osx" ]; then bash db-setup/travis-postgres-macos.sh; bash db-setup/postgres-reset-macos.sh; fi
  - if [ $TRAVIS_OS_NAME = "osx" ]; then bash db-setup/travis-mariadb-macos.sh; bash db-setup/mariadb-reset-macos.sh; fi

addons:
  apt:
    packages:
      # this is to make the odbc/psql packages work
      - unixodbc-dev
      - odbc-postgresql
      - libpq-dev

before_script:
  - if [ $TRAVIS_OS_NAME = "linux" ]; then export DBTEST_DISABLE_PG=true; fi
  - if [ $TRAVIS_OS_NAME = "linux" ]; then export DBTEST_DISABLE_MARIA=true; fi
  - if [ $TRAVIS_OS_NAME = "linux" ]; then sudo apt install unixodbc-dev odbc-postgresql; fi
  # we have to install from source, or else we get `result_fetch(res@ptr, n = n)`
  - R -q -e 'install.packages(c("RMariaDB","odbc","RPostgreSQL","RPostgres"), type = "source");'
  - odbcinst -j
  - cat /etc/odbcinst.ini
  - cat /etc/odbc.ini
  - echo "/usr/lib/"
  - ls -la /usr/lib/
  - echo "/usr/lib/x86_64-linux-gnu/odbc/"
  - ls -la /usr/lib/x86_64-linux-gnu/odbc/

r:
  - oldrel
  - release
  - devel
os:
  - linux
  - osx
matrix:
  exclude:
  - os: osx
    r: oldrel
  - os: osx
    r: devel


# recreate the databases so they are not cached between runs (and they can be used by codecovr)
before_cache:
  - if [ $TRAVIS_OS_NAME = "linux" ]; then bash db-setup/postgres-reset.sh; fi
  - if [ $TRAVIS_OS_NAME = "osx" ]; then bash db-setup/postgres-reset-macos.sh; bash db-setup/mariadb-reset-macos.sh; fi
  - Rscript -e 'remotes::install_cran("pkgdown")'

# deploy docs to ghpages automatically
deploy:
  provider: script
  on:
    branch: master
    condition: $TRAVIS_OS_NAME = linux && $TRAVIS_R_VERSION_STRING = release
  script: Rscript -e 'pkgdown::deploy_site_github()'
  skip_cleanup: true

after_success:
  - test $TRAVIS_R_VERSION_STRING = "release" && test $TRAVIS_OS_NAME = "linux" && Rscript -e 'covr::codecov()'
